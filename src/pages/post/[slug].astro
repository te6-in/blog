---
import { getCollection, getEntries, render } from "astro:content";
import { BaselineStatus } from "astro-embed";
import Prose from "../../components/Prose.astro";
import AnchorWithLinkPreviewTooltip from "../../components/mdx/AnchorWithLinkPreviewTooltip";
import Bluesky from "../../components/mdx/Bluesky.astro";
import Callout from "../../components/mdx/Callout.astro";
import Foo from "../../components/mdx/Foo.astro";
import Hr from "../../components/mdx/Hr.astro";
import LinkPreviewCard from "../../components/mdx/LinkPreviewCard";
import Twitter from "../../components/mdx/Twitter.astro";
import YouTube from "../../components/mdx/YouTube.astro";
import Layout from "../../layouts/Layout.astro";
import { getTag } from "../../lib/contents";
import TagChip from "../../components/TagChip.astro";
import AuthorChip from "../../components/AuthorChip.astro";
import MetadataGrid from "../../components/MetadataGrid.astro";
import Comments from "../../components/Comments.astro";
import PrevNextNavigation from "../../components/PrevNextNavigation";
import SeriesNavigation from "../../components/SeriesNavigation.astro";
import ActionButtons from "../../components/ActionButtons.astro";
import TableOfContents from "../../components/TableOfContents";
import ImageWithInferredAlt from "../../components/ImageWithInferredAlt.astro";
import AppleMusic from "../../components/mdx/AppleMusic.astro";

export async function getStaticPaths() {
  const posts = await getCollection("post");

  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

const tagsWithCount = await Promise.all(post.data.tags.map(getTag));

const authors = await getEntries(post.data.authors);

const variant = post.data.coverImage ? "glass" : "flat";
---

<Layout>
  <div
    class="w-full relative rounded-t-lg sidebar-shown:rounded-b-lg transition-[border-radius] overflow-hidden"
  >
    <div class="flex flex-col justify-end gap-5 p-8 z-10 relative">
      <div class="flex flex-col gap-2">
        <h1
          class:list={[
            "text-3xl leading-11 font-semibold text-balance",
            variant === "glass" ? "text-white" : "text-neutral-800",
          ]}
        >
          {post.data.title}
        </h1>
        <p
          class:list={[
            "text-balance text-lg",
            variant === "glass" ? "text-white/80" : "text-neutral-600",
          ]}
        >
          {post.data.description}
        </p>
      </div>
      <ul role="list" class="flex gap-1.5 flex-wrap">
        {
          tagsWithCount.map((tag) => (
            <li>
              <TagChip variant={variant} {...tag} />
            </li>
          ))
        }
      </ul>
      <div class="flex items-end justify-between gap-4 flex-wrap">
        <ul role="list" class="flex flex-wrap gap-3 translate-y-2.5">
          {
            authors.map(({ id, data }) => (
              <li>
                <AuthorChip variant={variant} id={id} {...data} />
              </li>
            ))
          }
        </ul>
        <MetadataGrid
          variant={variant}
          publishedAt={post.data.publishedAt}
          updatedAt={post.data.updatedAt}
        />
      </div>
    </div>
    {
      post.data.coverImage && (
        <div class="absolute inset-0">
          <ImageWithInferredAlt
            src={post.data.coverImage}
            class="size-full object-cover motion-safe:animate-pulse bg-neutral-400 select-none"
            onload="this.classList.remove('motion-safe:animate-pulse')"
          />
          <div class="bg-gradient-to-b from-black/85 to-black/60 inset-0 absolute contrast-more:backdrop-blur-lg transition-[backdrop-filter]" />
        </div>
      )
    }
  </div>
  <div
    class="toc-shown:flex toc-shown:flex-row-reverse gap-3.5 grid grid-cols-1"
  >
    <div
      class="contents toc-shown:flex flex-col justify-between items-end pt-0 toc-shown:w-56 flex-none relative"
    >
      <aside
        class="overflow-hidden sticky top-4 w-full max-h-[calc(100vh-2rem)] hidden toc-shown:block"
      >
        <TableOfContents headings={headings} class="h-full pb-50 ps-0.5 pe-5" />
      </aside>
      <div
        class="sticky bottom-0 w-full h-64 pointer-events-none contents toc-shown:flex justify-end items-end"
      >
        <div
          class="absolute inset-0 bg-gradient-to-b from-transparent to-white h-64 pointer-events-none hidden toc-shown:block"
        >
        </div>
        <ActionButtons
          class="sticky bottom-4 m-4 mt-0 pt-4 sidebar-shown:bottom-8 sidebar-shown:mb-8 row-start-1 row-end-1 col-start-1 col-end-1 self-end justify-self-end z-40 transition-[bottom,margin] toc-shown:sticky toc-shown:mb-12 toc-shown:me-8 toc-shown:inset-[unset]"
        />
      </div>
    </div>
    <div
      class="flex flex-col pb-19 sidebar-shown:pb-26 toc-shown:pb-12 sidebar-shown:gap-2 toc-shown:gap-6 overflow-x-hidden row-start-1 row-end-1 col-start-1 col-end-1 transition-[padding,gap]"
    >
      <SeriesNavigation currentType={post.collection} currentSlug={post.id} />
      <div class="flex flex-col px-4 toc-shown:ps-8 pt-4 gap-12">
        <Prose>
          <Content
            components={{
              Callout,
              LinkPreviewCard,
              AppleMusic,
              Twitter,
              YouTube,
              Bluesky,
              BaselineStatus,
              ImageGrid: Foo,
              img: ImageWithInferredAlt,
              a: AnchorWithLinkPreviewTooltip,
              hr: Hr,
            }}
          />
        </Prose>
        <Comments />
        <PrevNextNavigation
          navigateIn={post.collection}
          currentSlug={post.id}
        />
      </div>
    </div>
  </div>
</Layout>
