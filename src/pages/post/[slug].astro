---
import { getCollection, getEntries, render } from "astro:content";
import { BaselineStatus } from "astro-embed";
import Prose from "../../components/Prose.astro";
import AnchorWithLinkPreviewTooltip from "../../components/mdx/AnchorWithLinkPreviewTooltip";
import Bluesky from "../../components/mdx/Bluesky.astro";
import Callout from "../../components/mdx/Callout.astro";
import Hr from "../../components/mdx/Hr.astro";
import LinkPreviewCard from "../../components/mdx/LinkPreviewCard";
import Twitter from "../../components/mdx/Twitter.astro";
import YouTube from "../../components/mdx/YouTube.astro";
import Layout from "../../layouts/Layout.astro";
import { getTag } from "../../lib/contents";
import TagChip from "../../components/TagChip.astro";
import AuthorChip from "../../components/AuthorChip.astro";
import MetadataGrid from "../../components/MetadataGrid.astro";
import Comments from "../../components/Comments.astro";
import PrevNextNavigation from "../../components/PrevNextNavigation";
import SeriesNavigation from "../../components/SeriesNavigation.astro";
import ActionButtons from "../../components/ActionButtons.astro";
import TableOfContents from "../../components/TableOfContents";
import ImageWithInferredAlt from "../../components/ImageWithInferredAlt.astro";
import AppleMusic from "../../components/mdx/AppleMusic.astro";
import MainHeader from "../../components/MainHeader.astro";
import ImageGrid from "../../components/mdx/ImageGrid.astro";
import ImageColumns from "../../components/mdx/ImageColumns.astro";
import ImageStack from "../../components/mdx/ImageStack.astro";
import {
  getBreadcrumbListsFromTags,
  getPeopleFromAuthors,
  getPostBlogPostingId,
} from "../../lib/json-ld";
import type { BlogPosting, BreadcrumbList, WithContext } from "schema-dts";
import { $path } from "astro-typesafe-routes/path";
import JsonLd from "../../components/JsonLd.astro";
import { METADATA } from "../../lib/metadata";
import type { GetStaticPaths } from "astro";
import { getAlt } from "../../lib/images";

export const getStaticPaths = (async () => {
  const posts = await getCollection("post");

  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}) satisfies GetStaticPaths;

const { post } = Astro.props;
const { Content, headings } = await render(post);

const variant = post.data.coverImage ? "glass" : "flat";

const tagsWithCount = await Promise.all(post.data.tags.map(getTag));

const authors = await getEntries(post.data.authors);

const authorPeople = getPeopleFromAuthors(authors, Astro.url);

const blogPosting: WithContext<BlogPosting> = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "@id": getPostBlogPostingId(post, Astro.url),
  headline: post.data.title,
  description: post.data.description,
  keywords: tagsWithCount.map(({ name }) => name),
  author: authorPeople,
  copyrightHolder: authorPeople,
  url: Astro.url.href,
  dateCreated: post.data.publishedAt.toISOString(),
  datePublished: post.data.publishedAt.toISOString(),
  ...(post.data.updatedAt && {
    dateModified: post.data.updatedAt.toISOString(),
  }),
  articleBody: post.body,
  ...(post.data.coverImage && {
    thumbnailUrl: new URL(post.data.coverImage.src, Astro.url.origin).href,
  }),
};

const postBreadcrumbList: WithContext<BreadcrumbList> = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: METADATA.lexicons.index.label,
      item: Astro.url.origin,
    },
    {
      "@type": "ListItem",
      position: 2,
      name: METADATA.lexicons.posts.label,
      item: new URL($path({ to: "/posts" }), Astro.url.origin).href,
    },
  ],
};

const tagsBreadcrumbLists = getBreadcrumbListsFromTags(
  tagsWithCount,
  Astro.url
);

const coverImageAlt = post.data.coverImage
  ? await getAlt({ src: post.data.coverImage })
  : null;
---

<Layout
  metadataProps={{
    title: post.data.title,
    description: post.data.description,
    keywords: tagsWithCount.map(({ name }) => name),
    authors: authors.map(({ id, data: { name } }) => ({ id, name })),
    ...(post.data.coverImage &&
      coverImageAlt && {
        image: {
          src: post.data.coverImage.src,
          alt: coverImageAlt,
        },
      }),
    article: {
      publishedAt: post.data.publishedAt,
      updatedAt: post.data.updatedAt,
    },
    canonicalUrl: new URL(
      $path({ to: "/post/[slug]", params: { slug: post.id } }),
      Astro.url.origin
    ).href,
  }}
>
  <MainHeader class="w-full" {...post.data}>
    <ul role="list" class="flex gap-1.5 flex-wrap">
      {
        tagsWithCount.map((tag) => (
          <li>
            <TagChip variant={variant} {...tag} />
          </li>
        ))
      }
    </ul>
    <div class="flex items-end justify-between gap-4 flex-wrap">
      <ul role="list" class="flex flex-wrap gap-3 translate-y-2.5">
        {
          authors.map(({ id, data }) => (
            <li>
              <AuthorChip variant={variant} id={id} {...data} />
            </li>
          ))
        }
      </ul>
      <MetadataGrid
        variant={variant}
        publishedAt={post.data.publishedAt}
        updatedAt={post.data.updatedAt}
      />
    </div>
  </MainHeader>
  <div
    class="toc-shown:flex toc-shown:flex-row-reverse gap-3.5 grid grid-cols-1"
  >
    <div
      class="contents toc-shown:flex flex-col justify-between items-end pt-0 toc-shown:w-56 flex-none relative"
    >
      <aside
        class="overflow-hidden sticky top-4 w-full max-h-[calc(100vh-2rem)] hidden toc-shown:block"
      >
        <TableOfContents headings={headings} class="h-full pb-50 ps-0.5 pe-5" />
      </aside>
      <div
        class="sticky bottom-0 w-full h-64 pointer-events-none contents toc-shown:flex justify-end items-end"
      >
        <div
          class="absolute inset-0 bg-gradient-to-b from-transparent to-white h-64 pointer-events-none hidden toc-shown:block"
        >
        </div>
        <ActionButtons
          class="sticky bottom-4 m-4 mt-0 pt-4 sidebar-shown:bottom-8 sidebar-shown:mb-8 grid-pos-start self-end justify-self-end z-40 transition-[bottom,margin] toc-shown:sticky toc-shown:mb-12 toc-shown:me-8 toc-shown:inset-[unset]"
        />
      </div>
    </div>
    <div
      class="flex flex-col pb-19 sidebar-shown:pb-26 toc-shown:pb-12 overflow-x-hidden gap-1 grid-pos-start transition-[padding]"
    >
      <SeriesNavigation
        currentType={post.collection}
        currentSlug={post.id}
        class="p-4 pb-1 sidebar-shown:p-0 sidebar-shown:mb-2 transition-[padding]"
      />
      <div
        class="flex flex-col px-5 pt-6 toc-shown:ps-8 toc-shown:pe-4 sidebar-shown:pt-4 gap-12 transition-[padding]"
      >
        <Prose>
          <Content
            components={{
              Callout,
              LinkPreviewCard,
              AppleMusic,
              Twitter,
              YouTube,
              Bluesky,
              BaselineStatus,
              ImageColumns,
              ImageGrid,
              ImageStack,
              img: ImageWithInferredAlt,
              a: AnchorWithLinkPreviewTooltip,
              hr: Hr,
            }}
          />
        </Prose>
        <Comments />
        <PrevNextNavigation
          navigateIn={post.collection}
          currentSlug={post.id}
        />
      </div>
    </div>
  </div>
</Layout>

<JsonLd data={[blogPosting, postBreadcrumbList, ...tagsBreadcrumbLists]} />
