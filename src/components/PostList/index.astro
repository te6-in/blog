---
import type { CollectionEntry } from "astro:content";
import { groupBy } from "es-toolkit";
import PostListItem from "./PostListItem.astro";

interface Props {
  posts: CollectionEntry<"post">[];
}

const { posts } = Astro.props;

const postsByYear = groupBy(posts, ({ data: { publishedAt } }) =>
  publishedAt.getFullYear()
);
---

<ol
  role="list"
  class="divide divide-y divide-neutral-300 px-2.5 sidebar-shown:px-1.5 pb-2.5 sidebar-shown:pb-5.5"
>
  {
    Object.entries(postsByYear)
      .sort(([yearA], [yearB]) => parseInt(yearB) - parseInt(yearA))
      .map(([year, posts], yearIndex) => (
        <li class="flex gap-2 sidebar-shown:gap-4 items-start flex-col sidebar-shown:flex-row">
          <div class="font-semibold text-sm text-neutral-500 ps-5.5 sidebar-shown:ps-6.5 pt-5.5 sidebar-shown:pb-5.5 sidebar-shown:sticky sidebar-shown:top-0">
            {year}
          </div>
          <ol
            role="list"
            class="divide-y divide-neutral-200 w-full sidebar-shown:w-[unset] sidebar-shown:grow"
          >
            {posts.map(({ id, data }, postIndex) => (
              <li>
                <PostListItem
                  slug={id}
                  {...data}
                  position={{
                    firstGlobal: postIndex === 0 && yearIndex === 0,
                    firstInYear: postIndex === 0,
                    last:
                      postIndex === posts.length - 1 &&
                      yearIndex === Object.keys(postsByYear).length - 1,
                  }}
                />
              </li>
            ))}
          </ol>
        </li>
      ))
  }
</ol>
