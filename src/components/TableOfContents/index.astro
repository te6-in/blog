---
// TODO: add toc toggle

import type { MarkdownHeading } from "astro";
import NestedHeadingsList, {
  type NestedHeading,
} from "./NestedHeadingsList.astro";
import type { HTMLAttributes } from "astro/types";

interface Props extends HTMLAttributes<"nav"> {
  headings: MarkdownHeading[];
}

const { headings, class: className, ...props } = Astro.props;

function nestHeadings(headings: MarkdownHeading[]): NestedHeading[] {
  const nested: NestedHeading[] = [];
  const stack: NestedHeading[] = [];

  for (const heading of headings) {
    const newHeading: NestedHeading = { ...heading, children: [] };

    while (stack.length && stack[stack.length - 1].depth >= heading.depth) {
      stack.pop();
    }

    if (stack.length) {
      stack[stack.length - 1].children.push(newHeading);
    } else {
      nested.push(newHeading);
    }

    stack.push(newHeading);
  }

  return nested;
}

const nestedHeadings = nestHeadings(headings);
---

<nav
  class:list={[
    "overflow-y-auto [scrollbar-color:var(--color-gray-200)_transparent] dark:[scrollbar-color:var(--color-zinc-800)_transparent] [scrollbar-width:thin] flex flex-col text-sm",
    className,
  ]}
  {...props}
>
  <div
    class="sticky top-0 font-semibold bg-gradient-to-b from-content-card-bg dark:from-content-card-bg-dark to-transparent px-2.5 py-3 text-gray-700 dark:text-zinc-300 pointer-events-none flex items-center justify-between"
  >
    목차
  </div>
  <NestedHeadingsList nestedHeadings={nestedHeadings} />
</nav>
