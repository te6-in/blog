---
/**
 * from astro-embed-link-preview
 * https://github.com/delucis/astro-embed/blob/e5fa7e3018506eff78db1399bf9827c2af5b27ac/packages/astro-embed-link-preview/README.md
 */

import type { InferEntrySchema } from "astro:content";
import type { ComponentProps } from "astro/types";
import { match } from "ts-pattern";
import { METADATA } from "../../../lib/metadata";
import ImageWithInferredAlt from "../../ImageWithInferredAlt.astro";
import { getAnchor } from "../AnchorWithLinkPreviewTooltip/get-anchor";
import { parseOpenGraph } from "./lib";
import PreviewCard from "./PreviewCard.astro";

export interface Props {
  /** URL to fetch Open Graph data. */
  href: string;
  /** Hide any image or video even if set in the OpenGraph data. */
  hideMedia?: boolean;
  /** If true, the link will not have ?ref={site} appended to it. */
  noRef?: boolean;
}

const { href: __href, hideMedia = false, noRef = false } = Astro.props;

const { type, url, detail } = await getAnchor({
  href: __href,
  astroUrl: Astro.url,
  options: {
    noRef,
  },
});

const { href, metadata, internalImage, externalImage } = await match(type)
  .returnType<
    Promise<
      ComponentProps<typeof PreviewCard> &
        (
          | {
              internalImage?: InferEntrySchema<"post">["coverImage"]; // XXX
              externalImage?: never;
            }
          | {
              internalImage?: never;
              externalImage?: { src: string; alt?: string };
            }
        )
    >
  >()
  .with("post", async () => {
    if (type !== "post") throw new Error(""); // unreachable. for type safety
    if (!detail) throw new Error(`No Link metadata found for ${__href}`);

    const { title, description, coverImage } = detail;

    return {
      href: url.href,
      metadata: {
        title,
        description,
        siteName: `이 블로그의 ${METADATA.lexicons.posts.label}`,
        hasImage: hideMedia ? false : !!coverImage,
      },
      internalImage: coverImage,
    };
  })
  .with("snippet", async () => {
    if (type !== "snippet") throw new Error(""); // unreachable. for type safety
    if (!detail) throw new Error(`No Link metadata found for ${__href}`);

    return {
      href: url.href,
      metadata: {
        title: detail.title,
        siteName: `이 블로그의 ${METADATA.lexicons.snippets.label}`,
        hasImage: false,
      },
    };
  })
  .with("hash", async () => {
    throw new Error("Do not use Link with internal hash links");
  })
  .with("external", async () => {
    const meta = await parseOpenGraph(url.href);
    if (!meta) throw new Error(`No Link metadata found for ${url.href}`);
    if (!meta.title) throw new Error(`No title found for ${url.href}`);

    return {
      href: meta.url,
      metadata: {
        title: meta.title,
        description: meta.description ?? undefined,
        siteName: meta.siteName ?? undefined,
        hasImage: hideMedia ? false : !!meta.image,
      },
      ...(meta.image && {
        externalImage: {
          src: meta.image,
          alt: meta.imageAlt ?? undefined,
        },
      }),
    };
  })
  .exhaustive();

const IMAGE_CLASS = "motion-safe:group-engaged:scale-105 transition-transform";
---

{type === "post" && (
    <PreviewCard href={href} metadata={metadata} target="_blank">
      {internalImage && (
        <ImageWithInferredAlt class={IMAGE_CLASS} src={internalImage} />
      )}
    </PreviewCard>
  )}
{type === "snippet" && (
    <PreviewCard href={href} metadata={metadata} target="_blank" />
  )}
{type === "external" && (
    <PreviewCard href={href} metadata={metadata} target="_blank">
      {externalImage && (
        <img
          class:list={[
            IMAGE_CLASS,
            "bg-gray-200 dark:bg-zinc-800 not-noscript:motion-safe:animate-pulse",
          ]}
          {...externalImage}
          onload="this.classList.remove('not-noscript:motion-safe:animate-pulse')"
        />
      )}
    </PreviewCard>
  )}
