---
// biome-ignore lint/style/useImportType: limited support of biome for astro files
import { Image as AstroImage, getImage } from "astro:assets";
import { getCollection } from "astro:content";
import { removeQueryString } from "@astrojs/internal-helpers/path";
import type { ComponentProps } from "astro/types";

type Props = Omit<ComponentProps<typeof AstroImage>, "alt"> &
  Partial<Pick<ComponentProps<typeof AstroImage>, "alt">>;

const { src: __src, alt: __alt } = Astro.props;

const { src } = await getImage({ src: __src });
const decodedSrc = decodeURIComponent(src);

const fileName = removeQueryString(decodedSrc).split("/").pop();

const alt =
  __alt || (await getCollection("altText")).find(({ id }) => id === fileName?.split(".")[0])?.data;

if (!alt) throw new Error(`Alt text not found or empty. src: ${decodedSrc}`);
---
<AstroImage {...Astro.props as ComponentProps<typeof AstroImage>} alt={alt} />
