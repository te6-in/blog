---
import { getImage, Image } from "astro:assets";
import { getCollection } from "astro:content";
import { removeQueryString } from "@astrojs/internal-helpers/path";
import type { ComponentProps } from "astro/types";

type Props = Omit<ComponentProps<typeof Image>, "alt"> &
  Partial<Pick<ComponentProps<typeof Image>, "alt">>;

const { src: __src, alt: __alt } = Astro.props;

if (__alt) {
  throw new Error(
    `Alt text should not be provided. It must be found in the json file. src: ${__src}, alt: ${__alt}`,
  );
}

const { src } = await getImage({ src: __src });

const decodedSrc = decodeURIComponent(src);

const fileName = removeQueryString(decodedSrc).split("/").pop();

const alt = (await getCollection("altText")).find(({ id }) => id === fileName?.split(".")[0])?.data;

if (!alt) throw new Error(`Alt text not found or empty. src: ${decodedSrc}`);
---

<Image {...Astro.props as ComponentProps<typeof Image>} alt={alt} />
